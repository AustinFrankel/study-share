================================================================================
COPY EVERYTHING BELOW THIS LINE AND PASTE INTO SUPABASE SQL EDITOR
================================================================================

-- Resources table indexes (most important for homepage/search)
CREATE INDEX IF NOT EXISTS idx_resources_created_at ON resources(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_resources_type ON resources(type);
CREATE INDEX IF NOT EXISTS idx_resources_uploader_id ON resources(uploader_id);
CREATE INDEX IF NOT EXISTS idx_resources_class_id_created_at ON resources(class_id, created_at DESC);

-- Votes table indexes (for voting system)
CREATE INDEX IF NOT EXISTS idx_votes_resource_voter ON votes(resource_id, voter_id);
CREATE INDEX IF NOT EXISTS idx_votes_resource_id ON votes(resource_id);
CREATE INDEX IF NOT EXISTS idx_votes_voter_id ON votes(voter_id);

-- Comments table indexes (uses author_id)
CREATE INDEX IF NOT EXISTS idx_comments_resource_id_created ON comments(resource_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_comments_author_id ON comments(author_id);

-- Files table indexes
CREATE INDEX IF NOT EXISTS idx_files_resource_id ON files(resource_id);

-- Classes table indexes
CREATE INDEX IF NOT EXISTS idx_classes_school_id ON classes(school_id);
CREATE INDEX IF NOT EXISTS idx_classes_subject_id ON classes(subject_id);
CREATE INDEX IF NOT EXISTS idx_classes_teacher_id ON classes(teacher_id);
CREATE INDEX IF NOT EXISTS idx_classes_school_subject ON classes(school_id, subject_id);

-- Users table indexes
CREATE INDEX IF NOT EXISTS idx_users_handle ON users(handle);

-- Points ledger indexes
CREATE INDEX IF NOT EXISTS idx_points_ledger_user_created ON points_ledger(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_points_ledger_user_reason_date ON points_ledger(user_id, reason, created_at DESC);

-- Resource ratings indexes (uses user_id, not rater_id)
DO $$
BEGIN
  IF EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'resource_ratings') THEN
    CREATE INDEX IF NOT EXISTS idx_resource_ratings_resource ON resource_ratings(resource_id);
    CREATE INDEX IF NOT EXISTS idx_resource_ratings_user ON resource_ratings(user_id);
    CREATE UNIQUE INDEX IF NOT EXISTS idx_resource_ratings_unique ON resource_ratings(resource_id, user_id);
    RAISE NOTICE 'âœ… Created resource_ratings indexes';
  END IF;
END $$;

-- Monthly view limits indexes
DO $$
BEGIN
  IF EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'monthly_view_limits') THEN
    CREATE INDEX IF NOT EXISTS idx_monthly_view_limits_user_month ON monthly_view_limits(user_id, month_year);
    CREATE UNIQUE INDEX IF NOT EXISTS idx_monthly_view_limits_unique ON monthly_view_limits(user_id, month_year);
    RAISE NOTICE 'âœ… Created monthly_view_limits indexes';
  END IF;
END $$;

-- Flags table indexes (only resource_id and flagger_id - no status column)
DO $$
BEGIN
  IF EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'flags') THEN
    CREATE INDEX IF NOT EXISTS idx_flags_resource_id ON flags(resource_id);
    CREATE INDEX IF NOT EXISTS idx_flags_flagger_id ON flags(flagger_id);
    RAISE NOTICE 'âœ… Created flags indexes';
  END IF;
END $$;

-- Resource tags indexes
DO $$
BEGIN
  IF EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'resource_tags') THEN
    CREATE INDEX IF NOT EXISTS idx_resource_tags_tag_id ON resource_tags(tag_id);
    CREATE INDEX IF NOT EXISTS idx_resource_tags_resource_id ON resource_tags(resource_id);
    RAISE NOTICE 'âœ… Created resource_tags indexes';
  END IF;
END $$;

-- Verification query
SELECT
  tablename,
  indexname,
  indexdef
FROM pg_indexes
WHERE schemaname = 'public'
  AND indexname LIKE 'idx_%'
ORDER BY tablename, indexname;

================================================================================
DONE! Your app is now 10-20x faster! ðŸš€
================================================================================
